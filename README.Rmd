---
title: "README"
author: "Kiernan Nicholls"
date: "January 23, 2019"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.width = 10,
                      fig.height = 5,
                      cache = TRUE)
library(tidyverse)
library(knitr)
```

# _predictr_

Using R to compare the predictive capabilities of markets and models.

1. [Project Background](#project-background)
1. [Predictive Methods](#predictive-methods)
    1. [Polling and Aggregation](###polling-and-aggregation)
    1. [Forecasting Models](#forecasting-models)
    1. [Prediction Markets](#prediction-markets)
1. [Prediction Data](#prediction-data)
    1. [FiveThirtyEight Model](#fivethirtyeight-model)
    1. [PredictIt Markets](#predictit-markets)
1. [Data Wrangling](#data-wrangling)
1. [Data Exploration](#data-exploration)

## Project

The forecast model has become a staple of political punditry. Popularized by the
data journalism site [FiveThirtyEight][01], the forecast model is a statistical
tool used to incorporate a number of quantitative inputs and output a
probabilistic view of all possible outcomes.

Markets can be used as alternative method of generating similarly probabilistic
views of outcomes. Markets utilize the economic forces of price discovery and
risk aversion to overcome the implicit bias of self-interested traders on a
binary options exchange.

How do these two predictive methods fare in their ability to prediction
elections? I posit a null hypothesis of no difference in accuracy between
forecasting models and prediction markets in their ability to predict 2018
congressional midterm elections.

I will be using public model data from the proprietary model written by the
journalists at FiveThirtyEight and market data from the PredictIt exchange run
by the Victoria University of Wellington, New Zealand.

## Predictive Methods

### Polling and Aggrigation

Opinion polling is the most common form of election predicting. 
By [randomly sampling][05] the overall population of potential voters, pollsters
can ask a thousand Americans their voting intentions and determine the likely
division of votes in the actual election. Sampling errors and systemic errors
prevent this statistical tool from perfectly predicting the election. By
aggregating a bunch of polls and averaging result, sites like
[RealClearPolitics][06] take advantage of the [law of large numbers][07] to
better calculate the true opinion of the population.

### Forecasting Models

In [the word's][08] of Nate Silver, FiveThirtyEight's founder and the primary
author of their election forecasting model:

> (Forecasting models) take lots of polls, perform various types of adjustments
to them, and then blend them with other kinds of empirically useful indicators
(what we sometimes call “the fundamentals”) to forecast each race. Then they
account for the uncertainty in the forecast and simulate the election thousands
of times.

I will be using the FiveThirtyEight model to collect forecasting data. In 2016,
FiveThirtyEight's prediction was closest to reality. They are one of the few
mainstream forecasters to continue their work into the 2018 midterm elections.
Furthermore, the make the top-line output of their model free to the public.

The exact process of the FiveThirtyEight model is proprietary, so we can't know
exactly what data is being incorporated in what ways. We do know that the
"classic" version of their model, three types of quantitative data are used:

1. **Polling**: District-by-district polling, adjusted for house effects and
other factors in some unknown way. [FiveThirtyEight rates pollsters][09] to
adjust their findings.
2. **CANTOR**: A proprietary system which infers results for districts
with little or no polling from similar districts where polling has been done.
3. **Fundamentals**: Non-polling factors that historically help in predicting
congressional races:
    * Incumbency
    * State partisanship
    * Incumbent previous margins
    * Generic ballot
    * Fundraising
    * Incumbent voting record
    * Challenger experience
    * Scandals
    
From everything that has been said publicly about the mathematics of their
model, FiveThirtyEight uses these quantitative inputs to predict each
candidate's share of the vote. The model is then uses the statistical program
Stata to run a [Monte Carlo simulation][10]. By estimating the probability
distribution in two candidate's shares of the vote, such simulation can be run
tens of thousands of times. From these simulations, the percentage of one
candidate winning is equal to their probability of winning on election day.

In the training data (most House races since 1998), the classic model correctly
predicted **96.7%** of races at the time of election. FiveThirtyEight points out
that the _vast_ majority of races are blowouts and very easy to predict.

### Prediction Markets

As summarized [on Wikipedia][18]:

> Prediction markets (also known as predictive markets, information markets,
decision markets, idea futures, event derivatives, or virtual markets) are
exchange-traded markets created for the purpose of trading the outcome of
events. The market prices can indicate what the crowd thinks the probability of
the event is. A prediction market contract trades between 0 and 100%... The main
purposes of prediction markets are eliciting aggregating beliefs over an unknown
future outcome. Traders with different beliefs trade on contracts whose payoffs
are related to the unknown future outcome and the market prices of the contracts
are considered as the aggregated belief.

By utilizing the economic forces of risk aversion and self-interest, prediction
markets aim to overcome the implicit biases of the traders. Traders continually
buy and sell contracts that pay out at $1 based on the outcome of the election.

If a trader believes a candidate has a 75% chance of winning an election, he
should buy a hundred contracts at a price less than $0.75 each. Should events
unfold to increase or decrease this probability, the trader can sell these
shares for more or less than he originally paid, updating the market equilibrium
price to reflect current probabilities.

## Prediction Data

### Data Tables

```{r read_input, echo=FALSE, message=FALSE, warning=FALSE}
source("./code/01_input_scrape.R")
```

### FiveThirtyEight Model Data

The team at FiveThirtyEight makes public a portion of their model's output as
four separate `.csv` files on their website:

1. [Senate national forecast][11]
2. [Senate seat forecast][12]
3. [House national forecast][13]
4. [House district forecasts][14]

The two national forecasts provide the FiveThirtyEight calculations for each
party's probability of winning a majority in their respective chambers on any
given day (e.g., "Today, he Democratic party has an 85% chance of winning
control of the House of Representatives with a simple majority of seats").

The Senate seat and House district level forecasts will be used in this project.
Each observation represents one day's probability of victory for one candidate.
There are 28,353 observations in the Senate seat level file and 302,859 for the
House district level. Together, There are about 3,380 unique daily predictions from
August 1st to November 5th (97 days).

For each observation, there are 12 variables recorded:

1. The **date** of the prediction
2. The **State** the election is in
3. The Congressional **district** the election is in
4. Whether the election is a "**special** election"
5. The candidate's full **name**
6. The candidate's political **party**
7. The **model** version (classic, lite, or deluxe)
8. The candidate's **probability** of victory
9. The candidate's **expected share** of the vote (50th percentile)
10. The candidate's ≈**minimum share** of the vote (10th percentile)
10. The candidate's ≈**maximum share** of the vote (90th percentile)

Below is a random sample of observations from the FiveThirtyEight congressional
district model data set.

```{r model_data, echo=FALSE, message=FALSE}
model_district %>%
  sample_n(5) %>% 
  kable(format = "markdown",
        digits = 3,
        col.names = c("Date", 
                      "State", 
                      "District",
                      "Special",
                      "Name", 
                      "Party",
                      "Incumbent",
                      "Model",
                      "Win Prob.", 
                      "Avg Share",
                      "Min Share",
                      "Max Share"),
        caption = "299,760 observations of 7 variables")
```

### PredictIt Markets Data

PredictIt markets are comprised of "markets" and "contracts." As they explain on
[their website][15]:

> Every question posed by PredictIt is known as a "market" ... Each possible
answer to the question posed in a market is known as a "contract" ...
Single-contract markets resolve either to "Yes" or "No".

On [their webstie][16], PredictIt outlines their data agreement with academic
researchers:

> In order to take full advantage of the research opportunities presented by
prediction markets like PredictIt, we make our data available to members of the
academic community at no cost. PredictIt’s market data offers researchers a
wealth of information that can be used to further our understanding of a wide
array of subjects in fields of study as diverse as microeconomics, political
behavior, computer science and game theory.

I scraped [the PredictIt API][17] before the election and used the data to find
all market ID's related to Congressional elections. PredictIt then provided the
relevant market data as a `.csv` file.

Each observation represents one day's opening, closing, low, and high price for
a single contract from a single market. There are 44,711 observations covering
145 contracts across 118 markets. For each observation there are 11 variables:

1. Market ID
2. Market name (the "question" being asked)
3. Market symbol
4. Contract name (the possible "answers")
5. Contract symbol
6. Prediction date (earliest is 201-01-27)
7. Opening contract price
8. Low contract price
9. High contract price
10. Closing contract price (that day's final prediction)

Below is a random sample of observations from the PredictIt trading markets.

```{r market_data, echo=FALSE, message=FALSE}
market_data %>% 
  select(-MarketName, 
         -ContractName,
         -OpenPrice) %>% 
  sample_n(5) %>% 
  kable(format = "markdown",
        digits = 3,
        col.names = c("ID", 
                      "Market",
                      "Contract",
                      "Date",
                      "Low",
                      "High",
                      "Close",
                      "Volume"),
        caption = "44,711 observations of 6 variables")
```

## Data Wrangling

The above data sets were formatted to contain three relational keys variables: `date`, `code`, and `party`. 

The `code` variable is created by combinding the `state` and `district`
variables from FiveThirtyEight and extracted `MarketSymbol` variable from
PredictIt. For House races, the number refers to the Congressional District. For
Senate races, 99 indicates a on-time election and 98 indicates a special
election.

The `party` variable is included in the model data by default. For market data,
House race party variables are is extracted from "DEM" and "GOP" in the
`ContractSymbol` character string. Senate race party variables are obtained
using the incumbet's name in the `MarketSymbol` character string and the
`/congress-legislators` data set maintained by the [@United States project][19].

We then gather the variables to make out data frame "tidy" with each observation
representing one prediction (on one date, for one candidate, with one method).
The resulting data set has 29,602 observations with nine variables.

```{r joined_probs, echo=FALSE, message=FALSE}
predictions %>% 
  .[1:10, ] %>% 
  kable(format = "markdown",
        digits = 4,
        col.names = c("Date", 
                      "Race",
                      "Name",
                      "Chamber",
                      "Party",
                      "Incumbent",
                      "Special",
                      "Method",
                      "Probability"),
        caption = "29,602 observations of 9 variables")
```

## Data Exploration

The FiveThirtyEight model generates daily probabilities for every election in
both chambers. On PredictIt.org, some markets were open for trading as early as
January and the rest were added over time. Furthermore, the traders on
PredictIt.org are not interested in betting on every election, as the vast
majority have little risk (only 91 races were traded on prediction markets by
election day).

Below are histograms of the Democratic candidates' probabilities the day before
the election, split by the predictive method used. Note how the model, which
includes every race, gives the vast majority of candidates a less than 10% or
greater than 90% chance of winning their respective elections. The market, on
the other hand, is more uniform it its distribution of probabilities. Also note
the greater focus on Senate races on the prediction markets.

When comparing the two methods on their ability to predict elections, only races
included in both data sets will be used. This should not greatly bias results,
as the majority of races not shared have essentially foregone conclusions.

```{r dist, echo=FALSE, message=FALSE, warning=FALSE}
left_join(x = model,
          y = market,
          by = c("date", "race", "party")) %>%
  filter(date == "2018-11-05", 
         party == "D") %>%
  select(date,
         race,
         chamber,
         close,
         prob) %>%
  rename(market = close,
         model = prob) %>%
  gather(market, model,
         key = "method",
         value = "prob") %>%
  ggplot() +
  geom_histogram(mapping = aes(x = prob, fill = chamber), binwidth = 0.10) +
  facet_wrap(~method, scales = "free_y") +
  labs(title = "Distribution of Race Probabilities by Predictive Method",
       subtitle = "Day Before Election",
       x = "Democratic Win Probability",
       y = "Number of Races") +
  scale_x_continuous(breaks = seq(from = 0, to = 1, by = 0.25)) +
  scale_fill_manual(values = c("#595959", "black"))
```

The FiveThirtyEight model predicts 480 races every day from August 1st to
November 5th. Below is a graph showing the number of election markets on the
PredictIt exchange over that same time period. There are 127 races predicted
on August 1st, increasing to 189 races by election day. In the combined data
set, only days for which there are predictions by both methods are included.

```{r n_markets, echo=FALSE}
market %>% 
  filter(date > "2018-08-01",
         date < "2018-11-05") %>% 
  group_by(date) %>%
  summarise(count = n()) %>% 
  ggplot() +
  geom_line(mapping = aes(date, count),
            size = 2,
            color = "#595959") +
  labs(title = "Increase in Election Markets Over Time",
       subtitle = "On PredictIt.org",
       x = "Date",
       y = "Number of Elections")
```

----

[01]: https://fivethirtyeight.com/ "538 home page"
[02]: https://web.archive.org/web/20161107220421/https://projects.fivethirtyeight.com/2016-election-forecast/ "538 2016"
[03]: https://web.archive.org/web/20161108001708/https://www.nytimes.com/interactive/2016/upshot/presidential-polls-forecast.html "NYT Upshot 2016"
[04]: https://web.archive.org/web/20161107013120/http://elections.huffingtonpost.com/2016/forecast/president "HuffPo 2016"
[05]: https://en.wikipedia.org/wiki/Sampling_(statistics) "Sandom sampling wiki"
[06]: https://www.realclearpolitics.com/ "RCP home page"
[07]: https://en.wikipedia.org/wiki/Law_of_large_numbers "Law large nums wiki"
[08]: https://fivethirtyeight.com/methodology/how-fivethirtyeights-house-and-senate-models-work/ "538 model how"
[09]: https://projects.fivethirtyeight.com/pollster-ratings/ "538 poll ratings"
[10]: https://en.wikipedia.org/wiki/Monte_Carlo_method "Monte carlo sim wiki"
[11]: https://projects.fivethirtyeight.com/congress-model-2018/senate_national_forecast.csv "Sen nat model"
[12]: https://projects.fivethirtyeight.com/congress-model-2018/senate_seat_forecast.csv "Sen seat model"
[13]: https://projects.fivethirtyeight.com/congress-model-2018/house_national_forecast.csv "House nat model"
[14]: https://projects.fivethirtyeight.com/congress-model-2018/house_district_forecast.csv "House dis model"
[15]: https://www.predictit.org/support/faq "PredictIt FAQ"
[16]: https://www.predictit.org/research "PredictIt research"
[17]: https://www.predictit.org/api/marketdata/all/ "PredictIt API"
[18]: https://en.wikipedia.org/wiki/Prediction_market "Prediction markets wiki"
[19]: https://theunitedstates.io/ "@United States"
