---
title: "README"
author: "Kiernan Nicholls"
date: "January 23, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      error = FALSE,
                      cache = TRUE,
                      fig.width = 10,
                      fig.height = 5)
library(tidyverse)
library(knitr)
```

# _predictr_

Using R to compare the predictive capabilities of markets and models.

1. [Project Background](#project-background)
1. [Predictive Methods](#predictive-methods)
    1. [Polling and Aggregation](###polling-and-aggregation)
    1. [Forecasting Models](#forecasting-models)
    1. [Prediction Markets](#prediction-markets)
1. [Prediction Data](#prediction-data)
    1. [FiveThirtyEight Model](#fivethirtyeight-model)
    1. [PredictIt Markets](#predictit-markets)
1. [Data Wrangling](#data-wrangling)
1. [Data Exploration](#data-exploration)

```{r input_scrape}
source("./code/01_input_scrape.R")
```

```{r members_format}
source("./code/02_members_format.R")
```

```{r model_format}
source("./code/03_model_format.R")
```

```{r market_format}
source("./code/04_market_format.R")
```

```{r results_format}
source("./code/05_results_format.R")
```

```{r compare_format}
source("./code/06_compare_format.R")
```

```{r lean_format}
source("./code/07_lean_format.R")
```

```{r polling_format}
source("./code/08_polling_format.R")
```

```{r explore_plots}
source("./code/09_explore_plots.R")
```

## Project

The forecast model has become a staple of political punditry. Popularized by the
data journalism site [FiveThirtyEight][01], the forecast model is a statistical
tool used to incorporate a number of quantitative inputs and output a
probabilistic view of all possible outcomes.

Markets can be used as alternative method of generating similarly probabilistic
views of outcomes. Markets utilize the economic forces of price discovery and
risk aversion to overcome the implicit bias of self-interested traders on a
binary options exchange.

How do these two predictive methods fare in their ability to prediction
elections? I posit a null hypothesis of no difference in accuracy between
forecasting models and prediction markets in their ability to predict 2018
congressional midterm elections.

I will be using public model data from the proprietary model written by the
journalists at FiveThirtyEight and market data from the PredictIt exchange run
by the Victoria University of Wellington, New Zealand.

## Predictive Methods

### Polling and Aggrigation

Opinion polling is the most common form of election predicting. 
By [randomly sampling][05] the overall population of potential voters, pollsters
can ask a thousand Americans their voting intentions and determine the likely
division of votes in the actual election. Sampling errors and systemic errors
prevent this statistical tool from perfectly predicting the election. By
aggregating a bunch of polls and averaging result, sites like
[RealClearPolitics][06] take advantage of the [law of large numbers][07] to
better calculate the true opinion of the population.

### Forecasting Models

As Nate Silver, FiveThirtyEight's founder and the primary author of their model,
explains in their [methedological article][08]:

> (Forecasting models) take lots of polls, perform various types of adjustments
to them, and then blend them with other kinds of empirically useful indicators
(what we sometimes call “the fundamentals”) to forecast each race. Then they
account for the uncertainty in the forecast and simulate the election thousands
of times.

I will be using the FiveThirtyEight model's forecasting data. In 2016,
FiveThirtyEight's prediction was closest to reality. They are also one of the
few mainstream forecasters to continue their work into the 2018 midterm
elections. Furthermore, the make the top-line output of their model free to the
public.

The goal of these mathematical forecasting models, [according to Silver][21], is
"not to divine some magic formula that miraculously predicts every election.
Instead, it’s to make sense of publicly available information in a rigorous and
disciplined way."

#### Model Inputs

FiveThirtyEight's 2018 House and Senate models incorporate four types of
quantitative data:

1. **Polling:** District level polling. [FiveThirtyEight rates pollsters][09] to
adjust their findings. The results are further adjusted three times:
    1. The likely voter adjustment ensures a more accurate sampling frame.
    1. The conservative timeline adjustment to favor recency.
    1. The house effects adjustment corrects for persistent statistical biases.
1. **CANTOR:** A proprietary k-nearest neighbors algorithm to identify similar
congressional districts (based on demographic, geographic and political factors)
to infers results for polling-sparce districts.
1. **Fundamentals:** Non-polling factors that historically help in predicting
congressional races:
    * Incumbency
    * Partisanship
    * Previous margin
    * Generic ballot
    * Fundraising
    * Incumbent voting
    * Challenger experience
    * [Scandals][20]
1. **Expert forecasts:** Ratings published by the historically accurate experts 
at the [Cook Political Report][22], [Inside Elections][23], and 
[Sabato’s Crystal Ball][24].

FiveThirtyEight uses these inputs to generate three models. The "classic" model
(which uses polling, CANTOR, and fundamentals) is considered the default.

#### Model Outputs

In describing the process of their 2014 Senate Model, Silver explains how the
above inputs are incorporated in producing a probabilistic output:

> Most election models (including [FiveThirtyEight's]) work in something like
the following way: First, they calculate the most likely outcome in a particular
state (“The Republican wins by 1 point”) and then they determine the degree of
uncertainty around that estimate. Most models do this by means of a normal
distribution or something similar to it.

FiveThirtyEight has historically considered six factors in determining the
degree of uncertainty around their estimated division of the eventual vote. In
an analysis of past elections, it has been proven that the degree of uncertainty
is _greater_ when:

1. There are more days to go until the election
1. There are fewer polls
1. The polls disagree more with one another
1. The polling average disagrees more with the state fundamentals
1. There are more undecideds or third-party voters in the polls
1. The race is more lopsided

With these quantitative factors in mind, the model calculates the probability
distribution in each candidate's share of the vote.

The model then runs uses these predicted shares to run a 
[Monte Carlo simulation][10]. In each iteration of the simulation, a share of
the vote for each candidate in a race is drawn from the above probability
distributions. A winner is determined and the simulation runs again. The
percentage of simulated elections won is analogous to the probability of victory
on election day.

### Prediction Markets

As summarized [on Wikipedia][18]:

> Prediction markets (also known as predictive markets, information markets,
decision markets, idea futures, event derivatives, or virtual markets) are
exchange-traded markets created for the purpose of trading the outcome of
events. The market prices can indicate what the crowd thinks the probability of
the event is. A prediction market contract trades between 0 and 100%... The main
purposes of prediction markets are eliciting aggregating beliefs over an unknown
future outcome. Traders with different beliefs trade on contracts whose payoffs
are related to the unknown future outcome and the market prices of the contracts
are considered as the aggregated belief.

By utilizing the economic forces of risk aversion and self-interest, prediction
markets aim to overcome the implicit biases of the traders. Traders continually
buy and sell contracts that pay out at $1 based on the outcome of the election.

If a trader believes a candidate has a 75% chance of winning an election, he
should buy a hundred contracts at a price less than $0.75 each. Should events
unfold to increase or decrease this probability, the trader can sell these
shares for more or less than he originally paid, updating the market equilibrium
price to reflect current probabilities.

## Prediction Data

### FiveThirtyEight Model Data

The team at FiveThirtyEight makes public a portion of their model's output as
four separate `.csv` files on their website:

1. [`senate_national_forecast.csv`][11]
2. [`senate_seat_forecast.csv`][12]
3. [`house_national_forecast.csv`][13]
4. [`house_district_forecast.csv`][14]

The two national forecasts provide the FiveThirtyEight calculations for each
party's probability of winning a majority in their respective chambers on any
given day (e.g., "Today, he Democratic party has an 85% chance of winning
control of the House of Representatives with a simple majority of seats").

The Senate seat and House district level forecasts will be used in this project.
Each observation represents one day's probability of victory for one candidate.
There are 28,353 observations in the Senate seat level file and 302,859 for the
House district level. Together, There are about 3,380 unique daily predictions
from August 1st to November 5th (97 days).

For each observation, there are 12 variables recorded:

1. The date of the prediction
2. The State the election is in
3. The Congressional district the election is in
4. Whether the election is a "special election"
5. The candidate's full name
6. The candidate's political party
7. The model version (classic, lite, or deluxe)
8. The candidate's probability of victory
9. The candidate's expected share of the vote
10. The candidate's minimum share of the vote
10. The candidate's maximum share of the vote

Below is a random sample of observations from the FiveThirtyEight congressional
district model data set.

```{r model_data, echo=FALSE, message=FALSE}
model_district %>%
  select(-candidate, -p10_voteshare, -p90_voteshare) %>% 
  sample_n(5) %>%
  kable(format = "markdown",
        digits = 3,
        col.names = c("Date", 
                      "State", 
                      "District",
                      "Special",
                      "Party",
                      "Incumbent",
                      "Model",
                      "Win Prob.", 
                      "Avg Share"),
        caption = "299,760 observations of 7 variables")
```

### PredictIt Markets Data

PredictIt markets are comprised of "markets" and "contracts." As they explain on
[their website][15]:

> Every question posed by PredictIt is known as a "market" ... Each possible
answer to the question posed in a market is known as a "contract" ...
Single-contract markets resolve either to "Yes" or "No".

On [their webstie][16], PredictIt outlines their data agreement with academic
researchers:

> In order to take full advantage of the research opportunities presented by
prediction markets like PredictIt, we make our data available to members of the
academic community at no cost. PredictIt’s market data offers researchers a
wealth of information that can be used to further our understanding of a wide
array of subjects in fields of study as diverse as microeconomics, political
behavior, computer science and game theory.

I scraped [the PredictIt API][17] before the election and used the data to find
all market ID's related to Congressional elections. PredictIt then provided the
relevant market data as a `.csv` file.

Each observation represents one day's opening, closing, low, and high price for
a single contract from a single market. There are 44,711 observations covering
145 contracts across 118 markets. For each observation there are 11 variables:

1. Market ID
2. Market name
3. Market symbol
4. Contract name
5. Contract symbol
6. Prediction date
7. Opening contract price
8. Low contract price
9. High contract price
10. Closing contract price
11. Volume of shares traded

Below is a random sample of observations from the PredictIt trading markets.

```{r market_data, echo=FALSE, message=FALSE}
markets_data %>% 
  select(-MarketName, 
         -ContractName,
         -OpenPrice) %>% 
  sample_n(5) %>% 
  kable(format = "markdown",
        digits = 3,
        col.names = c("ID", 
                      "Market",
                      "Contract",
                      "Date",
                      "Low",
                      "High",
                      "Close",
                      "Volume"),
        caption = "44,711 observations of 6 variables")
```

## Data Wrangling

The above data sets were formatted to contain three keys variables: `date`,
`race`, and `party`. With these variables shared for each observation across
both the model and market data sets, a relational join can be performed.

For model data, the `race` variable is created by combining the `state` and
`district` variables. For market data, the race code is extracted from the
`MarketSymbol` variable.

The `party` variable is included in the model data by default. For market data,
House race party variables are extracted from "DEM" and "GOP" in the
`ContractSymbol` character string. Senate race party variables are obtained
using the incumbent's name in the `MarketSymbol` character string and the
`/congress-legislators` data set maintained by the @United States project.

We then gather the variables to make the single data frame "[tidy][19]" with each
observation representing one prediction (on one date, for one candidate, with
one method). The resulting data set has 29,602 observations with nine variables.

```{r joined_probs, echo=FALSE, message=FALSE}
read_csv("./output/predictions.csv") %>%
  .[1:10, ] %>% 
  knitr::kable(format = "markdown",
               digits = 4,
               col.names = c("Date", 
                             "Race",
                             "Name",
                             "Chamber",
                             "Party",
                             "Special",
                             "Incumbent",
                             "Method",
                             "Probability",
                             "Outcome"),
               caption = "29,602 observations of 9 variables")
```

## Data Exploration

The FiveThirtyEight model generates daily probabilities for every election in
both chambers. On PredictIt.org, some markets were open for trading as early as
January _2017_ and the rest were added over time. Furthermore, the traders on
PredictIt are not interested in betting on every election, as the vast majority
have little risk (only 111 races were traded on prediction markets by election
day).

Below are histograms of the Democratic candidates' probabilities the day before
the election, split by the predictive method used. The model, which includes
every race, gives the vast majority of candidates a less than 10% or greater
than 90% chance of winning their respective elections. The markets, which only
exist for the most contentious and popular races, are more uniform it their
distribution of probabilities.

Also below are plots showing the increase in input data over time for the
respective methods. Both polls and dollars traded (the two primary inputs for
each method) increase exponentially over time. Theoretically, more input data
would improve predictive accuracy.

```{r plots, echo=FALSE, message=FALSE, warning=FALSE}
plot_races_hist
plot_cum_markets
plot_cum_polls
plot_cum_dollars
```

[01]: https://fivethirtyeight.com/ "538 home page"
[02]: https://web.archive.org/web/20161107220421/https://projects.fivethirtyeight.com/2016-election-forecast/ "538 2016"
[03]: https://web.archive.org/web/20161108001708/https://www.nytimes.com/interactive/2016/upshot/presidential-polls-forecast.html "NYT Upshot 2016"
[04]: https://web.archive.org/web/20161107013120/http://elections.huffingtonpost.com/2016/forecast/president "HuffPo 2016"
[05]: https://en.wikipedia.org/wiki/Sampling_(statistics) "Sandom sampling wiki"
[06]: https://www.realclearpolitics.com/ "RCP home page"
[07]: https://en.wikipedia.org/wiki/Law_of_large_numbers "Law large nums wiki"
[08]: https://fivethirtyeight.com/methodology/how-fivethirtyeights-house-and-senate-models-work/ "538 model 2018"
[09]: https://projects.fivethirtyeight.com/pollster-ratings/ "538 poll ratings"
[10]: https://en.wikipedia.org/wiki/Monte_Carlo_method "Monte carlo sim wiki"
[11]: https://projects.fivethirtyeight.com/congress-model-2018/senate_national_forecast.csv "Sen nat model"
[12]: https://projects.fivethirtyeight.com/congress-model-2018/senate_seat_forecast.csv "Sen seat model"
[13]: https://projects.fivethirtyeight.com/congress-model-2018/house_national_forecast.csv "House nat model"
[14]: https://projects.fivethirtyeight.com/congress-model-2018/house_district_forecast.csv "House dis model"
[15]: https://www.predictit.org/support/faq "PredictIt FAQ"
[16]: https://www.predictit.org/research "PredictIt research"
[17]: https://www.predictit.org/api/marketdata/all/ "PredictIt API"
[18]: https://en.wikipedia.org/wiki/Prediction_market "Prediction markets wiki"
[19]: http://vita.had.co.nz/papers/tidy-data.html "Tidy data"
[20]: https://docs.google.com/spreadsheets/d/1ksBLxRR3GCZd33IvhkcNqqBd5K8HwlWC7YuAkVmS1lg/edit?usp=sharing "scandals data"
[21]: https://fivethirtyeight.com/features/how-the-fivethirtyeight-senate-forecast-model-works/ "538 model 2014"
[22]: https://cookpolitical.com/ "cook"
[23]: https://insideelections.com/ "inside"
[24]: http://www.centerforpolitics.org/crystalball/ "sabatos"
